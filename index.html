<!DOCTYPE html> 
<html> 
    <head> 
    <title>Snake</title>    
        <script src="http://code.jquery.com/jquery-1.6.1.min.js"></script>     
        <script>
            
            var JS_SNAKE = {};
            
            JS_SNAKE.game = (function() {
                
                JS_SNAKE.width = 400;
                JS_SNAKE.height = 400;
                JS_SNAKE.blockSize = 10; //px 
                
                var ctx;
                var frameLength = 500; //ms
                var snake;
                var apple;
                                
                function init(){                
                    var $canvas = $('#jsSnake');
                    $canvas.attr('width', JS_SNAKE.width);
                    $canvas.attr('height', JS_SNAKE.height);                                        
                    var canvas = $canvas[0];
                    ctx = canvas.getContext('2d');
                    snake = JS_SNAKE.snake();
                    apple = JS_SNAKE.apple();
                    bindEvents();
                    gameLoop();
                }
                
                function gameLoop(){                                       
                    update();
                    draw();                                        
                    setTimeout(gameLoop, frameLength);
                }
                
                function update(){
                    snake.update();
                }
                
                function draw(){
                    ctx.clearRect(0, 0, JS_SNAKE.width, JS_SNAKE.height); 
                    snake.draw(ctx);
                    drawBorder();
                    apple.draw(ctx);
                }
                
                function drawBorder(){
                    ctx.save();
                    ctx.strokeStyle = 'gray';
                    ctx.lineWidth = JS_SNAKE.blockSize;
                    ctx.lineCap = 'square';
                    var offset = ctx.lineWidth / 2;
                    var corners = [
                      [offset, offset],
                      [JS_SNAKE.width - offset, offset],
                      [JS_SNAKE.width - offset, JS_SNAKE.height - offset],
                      [offset, JS_SNAKE.height - offset]                      
                    ];
                    ctx.beginPath(); 
                    ctx.moveTo(corners[3][0], corners[3][1]);
                     $.each(corners, function (index, corner) {
                        ctx.lineTo(corner[0], corner[1]);
                    });
                                                                               
                    ctx.closePath(); 
                    ctx.stroke();
                    ctx.restore();
                }
                
                function bindEvents(){
                  var keysToDirections = {
                    37: 'left',
                    38: 'up',
                    39: 'right',
                    40: 'down'
                  };  
                  
                  $(document).keydown(function( event ){
                      var key = event.which;
                      var direction = keysToDirections[key];
                      
                      if(direction){                          
                          snake.setDirection(direction);
                          event.preventDefault();
                      }
                      
                  });
                }
                
                return { 
                    init: init 
                };
                
            })();
            
            JS_SNAKE.apple = function(){
                var position = [6, 6];
                
                function draw(ctx){
                    ctx.save();
                    ctx.fillStyle = '0a0';
                    ctx.beginPath();
                    var radius = JS_SNAKE.blockSize / 2;
                    var x = position[0] * JS_SNAKE.blockSize + radius;
                    var y = position[1] * JS_SNAKE.blockSize + radius;  
                    ctx.arc(x, y, radius, 0, Math.PI * 2, true);
                    ctx.closePath();   
                    ctx.fill();
                    ctx.restore();
                }
                
                return{
                    draw: draw
                }
            };
            
            JS_SNAKE.snake = function(){
                var posArray = [];
                posArray.push( [6, 4] );
                posArray.push( [5, 4] );
                posArray.push( [4, 4] );
                var direction = 'right';
                var nextDirection = direction;
                
                function setDirection(newDirection){
                    var allowedDirections;
                    switch(direction){
                        case 'left':
                        case 'right':
                            allowedDirections = ['up', 'down'];
                            break;
                        case 'up':
                        case 'down':
                            allowedDirections = ['left', 'right'];
                            break;
                        default:
                            throw('Invalid direction');
                    }
                    
                    if (allowedDirections.indexOf(newDirection) > -1){
                        nextDirection = newDirection;
                    }                    
                }
                
                function drawSection(ctx, position) {
                    var x = JS_SNAKE.blockSize * position[0];
                    var y = JS_SNAKE.blockSize * position[1];
                    ctx.fillRect(x, y, JS_SNAKE.blockSize, JS_SNAKE.blockSize);
                }
                
                function update() {
                    var nextPosition = posArray[0].slice(); //copy head of snake                 
                    direction = nextDirection;
                    switch(direction){
                        case 'left':
                            nextPosition[0] -=1;
                            break;
                        case 'up':
                            nextPosition[1] -=1;
                            break;
                        case 'right':
                            nextPosition[0] +=1;
                            break;
                        case 'down':
                            nextPosition[1] +=1;
                            break;
                    }
                                                                                 
                    posArray.unshift(nextPosition); //add the new position to the beginning of the array
                    posArray.pop(); //and remove the last position
                }
                
                function draw( ctx ){
                    ctx.save();
                    ctx.fillStyle = '#33a';
                    for(var i = 0; i < posArray.length; i++) {
                        drawSection(ctx, posArray[i]);
                    }                    
                    ctx.restore();                    
                }
                                                
                return { draw: draw, 
                         update: update,
                         setDirection: setDirection
                 };
                
            };
                                          
            $(document).ready(function(){           
                JS_SNAKE.game.init();           
            });
        </script>                        
    </head> 
    <body>         
        <h1>S</h1>
        <hr />
        <canvas id="jsSnake"></canvas>                
    </body>
</html>